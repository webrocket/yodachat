<script>
  var screenName = localStorage.hasOwnProperty("screenName") ?
    localStorage.screenName : "";
  
  while (screenName == "") {
    screenName = prompt("What's your name?");
    localStorage.screenName = screenName;
  }
  
  wsSend = function(ws, payload) {
    return ws.send(JSON.stringify(payload))
  }

  var ws = new WebSocket("ws://127.0.0.1:9772/yoda")

  ws.onopen = function() {
    wsSend(ws, {"auth": {"user": "yoda", "secret": "pass"}})
  }

  ws.onmessage = function(evt) {
    data = JSON.parse(evt.data);
    if (data.hasOwnProperty("__authenticated")) {
      wsSend(ws, {"subscribe":{"channel": "<%= params[:id] %>"}})
    } else if (data.hasOwnProperty("__subscribed")) {
      $("#chatlog").append("<li class='joined'>You joined the channel</li>")
    } else if (data.hasOwnProperty("event")) {
      if (data["event"] == "message_sent") {
        d = data["data"];
        text = d["message"];
        author = d["author"];
        $("#chatlog").append("<li><span class='author'>[" + author + "]</span> " + text + "</li>")
      }
    }
  }
</script>

<h2>On the '<%= params[:id] %>' room welcome!</h2>
<ul id="chatlog">
  
</ul>

<form id="new_message">
  <input type="text" value="" id="new_message_text" name="new_message[text]">
</form>

<script>
  $("#new_message_text").keypress(function(e) {
    if (e.which == 13) {
      wsSend(ws, {
        "broadcast": {
          "event": "message_sent",
          "channel": "<%= params[:id] %>",
          "data": {
            "author": screenName,
            "message": $(this).val()
          }
        }
      })
      $(this).val("");
      return false;
    }
  })
</script>
